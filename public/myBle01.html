

<script>
 var bluetoothDevice;
var batteryLevelCharacteristic;

async function onReadBatteryLevelButtonClick() {
  try {
    if (!bluetoothDevice) {
      await requestDevice();
    }
    await connectDeviceAndCacheCharacteristics();

    log('Reading Battery Level...');
    await batteryLevelCharacteristic.readValue();
  } catch(error) {
    log('Argh! ' + error);
  }
}

async function requestDevice() {
  log('Requesting any Bluetooth Device...');
  bluetoothDevice = await navigator.bluetooth.requestDevice({
   // filters: [...] <- Prefer filters to save energy & show relevant devices.
      acceptAllDevices: true,
      optionalServices: ['battery_service']});
  bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
}

async function connectDeviceAndCacheCharacteristics() {
  if (bluetoothDevice.gatt.connected && batteryLevelCharacteristic) {
    return;
  }

  log('Connecting to GATT Server...');
  const server = await bluetoothDevice.gatt.connect();

  log('Getting Battery Service...');
  const service = await server.getPrimaryService('battery_service');

  log('Getting Battery Level Characteristic...');
  batteryLevelCharacteristic = await service.getCharacteristic('battery_level');

  batteryLevelCharacteristic.addEventListener('characteristicvaluechanged',
      handleBatteryLevelChanged);
  document.querySelector('#startNotifications').disabled = false;
  document.querySelector('#stopNotifications').disabled = true;
}

/* This function will be called when `readValue` resolves and
 * characteristic value changes since `characteristicvaluechanged` event
 * listener has been added. */
function handleBatteryLevelChanged(event) {
  let batteryLevel = event.target.value.getUint8(0);
  log('> Battery Level is ' + batteryLevel + '%');
}

async function onStartNotificationsButtonClick() {
  try {
    log('Starting Battery Level Notifications...');
    await batteryLevelCharacteristic.startNotifications();

    log('> Notifications started');
    document.querySelector('#startNotifications').disabled = true;
    document.querySelector('#stopNotifications').disabled = false;
  } catch(error) {
    log('Argh! ' + error);
  }
}

async function onStopNotificationsButtonClick() {
  try {
    log('Stopping Battery Level Notifications...');
    await batteryLevelCharacteristic.stopNotifications();

    log('> Notifications stopped');
    document.querySelector('#startNotifications').disabled = false;
    document.querySelector('#stopNotifications').disabled = true;
  } catch(error) {
    log('Argh! ' + error);
  }
}

function onResetButtonClick() {
  if (batteryLevelCharacteristic) {
    batteryLevelCharacteristic.removeEventListener('characteristicvaluechanged',
        handleBatteryLevelChanged);
    batteryLevelCharacteristic = null;
  }
  // Note that it doesn't disconnect device.
  bluetoothDevice = null;
  log('> Bluetooth Device reset');
}

async function onDisconnected() {
  log('> Bluetooth Device disconnected');
  try {
    await connectDeviceAndCacheCharacteristics()
  } catch(error) {
    log('Argh! ' + error);
  }
} 
  
</script>
  
<h1 align=center> BLE test page </h1>
<h3>Version: 0.1.0</h3>  
  
  <input type=button value="connectDeviceAndCacheCharacteristics()" onclick="{ 
     connectDeviceAndCacheCharacteristics()
  }">


  <input type=button value="onDisconnected()" onclick="{
     onDisconnected()                                                  
  }">

  <input type=button value="onStartNotificationsButtonClick()" onclick="{ 
      onStartNotificationsButtonClick()                                 
  }">

  <input type=button value="onStopNotificationsButtonClick()" onclick="{ 
     onStopNotificationsButtonClick()                                  
  }">


  <input type=button value="" onclick="{ 
                                       
  }">

  <input type=button value="" onclick="{ 
                                       
  }">

  <input type=button value="onResetButtonClick()" onclick="{ 
     onResetButtonClick()                                  
  }">

  <input type=button value="onReadBatteryLevelButtonClick()" onclick="{ 
       onReadBatteryLevelButtonClick()                                
  }">

  <input type=button value="requestDevice()" onclick="{ 
     requestDevice()
  }">




<script>
  var ChromeSamples = {
    log: function() {
      var line = Array.prototype.slice.call(arguments).map(function(argument) {
        return typeof argument === 'string' ? argument : JSON.stringify(argument);
      }).join(' ');

      document.querySelector('#log').textContent += line + '\n';
    },

    clearLog: function() {
      document.querySelector('#log').textContent = '';
    },

    setStatus: function(status) {
      document.querySelector('#status').textContent = status;
    },

    setContent: function(newContent) {
      var content = document.querySelector('#content');
      while(content.hasChildNodes()) {
        content.removeChild(content.lastChild);
      }
      content.appendChild(newContent);
    }
  };
</script>

<h3>Live Output</h3>
<div id="output" class="output">
  <div id="content"></div>
  <div id="status"></div>
  <pre id="log"></pre>
</div>







